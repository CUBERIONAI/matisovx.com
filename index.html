<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Matisov X — Cyber Samurai</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
:root { --neon: #00d2ff; --bg: #02040a; }
* { -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }
body { margin: 0; background: var(--bg); color: #fff; font-family: 'Orbitron', sans-serif; overflow: hidden; height: 100vh; }

.glass { background: rgba(255,255,255,0.05); border: 1px solid rgba(0,210,255,0.2); border-radius: 20px; }
.btn-neon { background: var(--neon); color: #000; font-weight: 900; border-radius: 12px; }

/* Секретний екран */
#secretScreen { 
    position: fixed; inset: 0; background: #000; z-index: 500; 
    display: none; flex-direction: column; padding: 20px;
}

/* Модалка завдань та апгрейдів */
#hubModal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 400;
    display: none; flex-direction: column; padding: 20px;
}

.tap-text {
    position: absolute; color: var(--neon); font-weight: 900; pointer-events: none;
    animation: float 0.7s forwards; font-size: 1.5rem; text-shadow: 0 0 10px var(--neon);
}
@keyframes float { to { transform: translateY(-100px); opacity: 0; } }

#ton-connect-button { margin: 0 auto; }
</style>
</head>
<body>

<div id="gameUI" class="flex flex-col h-screen p-6">
    <header class="flex justify-between items-center mb-4">
        <div onclick="openSecret()" class="cursor-pointer">
            <h1 class="text-xl font-black text-cyan-400">MATISOV X</h1>
            <span id="lvlTag" class="text-[10px] bg-cyan-900 px-2 py-0.5 rounded">LVL 1</span>
        </div>
        <div class="text-right">
            <div class="text-[10px] opacity-60">BALANCE</div>
            <div id="balText" class="text-2xl font-black">0</div>
        </div>
    </header>

    <div class="flex-grow relative flex items-center justify-center" id="tapArea">
        <img id="hero" src="https://raw.githubusercontent.com/CUBERIONAI/Matisov-X/main/file_0000000008b471f48ebdb6f35b1b1a5a.png" class="h-[45vh] transition-transform duration-75">
    </div>

    <footer class="space-y-4">
        <div class="glass p-4">
            <div class="flex justify-between text-[10px] mb-1"><span>ENERGY</span><span id="eneText">1000/1000</span></div>
            <div class="h-1.5 bg-gray-800 rounded-full overflow-hidden"><div id="eneBar" class="h-full bg-cyan-400"></div></div>
        </div>
        <button onclick="openHub()" class="w-full btn-neon py-4 text-sm tracking-widest uppercase">Upgrades & Tasks</button>
    </footer>
</div>

<div id="secretScreen">
    <div class="flex justify-between mb-8">
        <h2 class="text-cyan-400 font-black">CYBER PROFILE</h2>
        <button onclick="closeSecret()" class="text-2xl font-bold">✕</button>
    </div>
    
    <div class="flex flex-col items-center mb-10">
        <img id="uAvatar" src="" class="w-20 h-20 rounded-full border-2 border-cyan-400 mb-2">
        <div id="uName" class="font-black text-lg">GUEST</div>
    </div>

    <div id="ton-connect-button"></div>
    
    <div class="mt-10 space-y-4">
        <div class="glass p-4 flex justify-between"><span>TON BALANCE</span><span id="tonBal">0.00</span></div>
        <button onclick="window.location.reload()" class="w-full text-xs opacity-50">SYNC DATA</button>
    </div>
</div>

<div id="hubModal">
    <div class="flex justify-between mb-6">
        <h2 class="text-cyan-400 font-black">HUB</h2>
        <button onclick="closeHub()" class="text-2xl">✕</button>
    </div>

    <div class="overflow-y-auto space-y-6">
        <section>
            <h3 class="text-[10px] text-gray-400 mb-3 tracking-widest">TASKS (VERIFIED)</h3>
            <div id="taskList" class="space-y-2"></div>
        </section>

        <section>
            <h3 class="text-[10px] text-gray-400 mb-3 tracking-widest">CYBER UPGRADES</h3>
            <div id="upgList" class="space-y-2"></div>
        </section>
    </div>
</div>

<script>
const TG = window.Telegram.WebApp;
const UID = TG.initDataUnsafe?.user?.id || "guest";
TG.expand();

// TON Connect Init
const tonConnectUI = new TONConnectUI.TonConnectUI({
    manifestUrl: 'https://raw.githubusercontent.com/ton-connect/demo-dapp/main/public/tonconnect-manifest.json',
    buttonRootId: 'ton-connect-button'
});

let state = {
    bal: parseInt(localStorage.getItem('mx_bal_'+UID)) || 0,
    e: 1000,
    lvl: 1,
    hnd: parseInt(localStorage.getItem('mx_hnd_'+UID)) || 0,
    swd: parseInt(localStorage.getItem('mx_swd_'+UID)) || 0,
    ton_connected: localStorage.getItem('mx_ton_con_'+UID) === 'true',
    tasks: JSON.parse(localStorage.getItem('mx_tsk_'+UID)) || []
};

const TASKS = [
    { id: 'tg_ch', title: 'Join Channel', reward: 1000000, link: 'https://t.me/Matisov_X' },
    { id: 'tg_group', title: 'Join Chat', reward: 1000000, link: 'https://t.me/MatisovX' },
    { id: 'yt', title: 'Subscribe YouTube', reward: 1000000, link: 'https://youtube.com/@MatisovX' },
    { id: 'ton_con', title: 'Connect TON Wallet', reward: 100000, link: '#' }
];

function save() {
    localStorage.setItem('mx_bal_'+UID, state.bal);
    localStorage.setItem('mx_hnd_'+UID, state.hnd);
    localStorage.setItem('mx_swd_'+UID, state.swd);
    localStorage.setItem('mx_tsk_'+UID, JSON.stringify(state.tasks));
}

function render() {
    document.getElementById('balText').textContent = state.bal.toLocaleString();
    document.getElementById('eneText').textContent = `${state.e}/${1000 + (state.hnd * 200)}`;
    document.getElementById('eneBar').style.width = (state.e / (1000 + (state.hnd * 200)) * 100) + "%";
    
    if(TG.initDataUnsafe?.user) {
        document.getElementById('uName').textContent = TG.initDataUnsafe.user.first_name;
        document.getElementById('uAvatar').src = TG.initDataUnsafe.user.photo_url || '';
    }
}

// Logic: Tasks
function openHub() {
    document.getElementById('hubModal').style.display = 'flex';
    const list = document.getElementById('taskList');
    list.innerHTML = TASKS.map(t => {
        const isDone = state.tasks.includes(t.id);
        return `
        <div class="glass p-3 flex justify-between items-center">
            <div><div class="text-xs font-bold">${t.title}</div><div class="text-[9px] text-green-400">+${t.reward.toLocaleString()} MX</div></div>
            ${isDone ? '<span class="text-green-500 text-xs">✔</span>' : 
            `<button onclick="verifyTask('${t.id}')" class="bg-white text-black text-[10px] px-3 py-1 rounded-full font-bold">GO</button>`}
        </div>`;
    }).join('');
}

function verifyTask(id) {
    const task = TASKS.find(t => t.id === id);
    if(id === 'ton_con') {
        if(tonConnectUI.connected) {
            claimTask(id, task.reward);
        } else {
            TG.showAlert("Please connect your wallet in Profile first!");
        }
    } else {
        TG.openLink(task.link);
        // Імітація перевірки через "Verification"
        setTimeout(() => {
            TG.showConfirm("Did you subscribe?", (ok) => {
                if(ok) claimTask(id, task.reward);
            });
        }, 2000);
    }
}

function claimTask(id, reward) {
    if(!state.tasks.includes(id)) {
        state.tasks.push(id);
        state.bal += reward;
        save(); render(); openHub();
        TG.HapticFeedback.notificationOccurred('success');
    }
}

// Logic: Taps
document.getElementById('tapArea').addEventListener('touchstart', (e) => {
    e.preventDefault();
    if(state.e <= 0) return;
    
    Array.from(e.changedTouches).forEach(touch => {
        state.e--;
        const gain = 1 + state.swd;
        state.bal += gain;
        
        const txt = document.createElement('div');
        txt.className = 'tap-text';
        txt.style.left = touch.clientX + 'px';
        txt.style.top = touch.clientY + 'px';
        txt.textContent = `+${gain}`;
        document.body.appendChild(txt);
        setTimeout(() => txt.remove(), 700);
        
        document.getElementById('hero').style.transform = 'scale(0.95)';
        setTimeout(() => document.getElementById('hero').style.transform = 'scale(1)', 50);
    });
    render(); save();
    TG.HapticFeedback.impactOccurred('medium');
});

// Navigation
function openSecret() { document.getElementById('secretScreen').style.display = 'flex'; }
function closeSecret() { document.getElementById('secretScreen').style.display = 'none'; }
function closeHub() { document.getElementById('hubModal').style.display = 'none'; }

// Wallet Sync
tonConnectUI.onStatusChange(wallet => {
    if (wallet) {
        state.ton_connected = true;
        localStorage.setItem('mx_ton_con_'+UID, 'true');
    }
});

setInterval(() => {
    const max = 1000 + (state.hnd * 200);
    if(state.e < max) { state.e = Math.min(max, state.e + 3); render(); }
}, 1500);

render();
</script>
</body>
</html>
