<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Matisov X — Cyber Samurai</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
:root { --neon: #00d2ff; --bg: #02040a; }
* { -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }
body { margin: 0; background: var(--bg); color: #fff; font-family: 'Orbitron', sans-serif; overflow: hidden; height: 100vh; }

/* Дизайн панелей */
.glass { background: rgba(255,255,255,0.05); border: 1px solid rgba(0,210,255,0.2); border-radius: 20px; }
.btn-neon { background: var(--neon); color: #000; font-weight: 900; border-radius: 12px; box-shadow: 0 0 15px var(--neon); }

/* Екрани */
#secretScreen, #hubModal { 
    position: fixed; inset: 0; background: rgba(0,0,0,0.97); z-index: 500; 
    display: none; flex-direction: column; padding: 25px; animation: fadeIn 0.3s;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* Герой */
#hero { height: 45vh; transition: transform 0.1s ease; filter: drop-shadow(0 0 20px var(--neon)); }
.tap-text {
    position: absolute; color: var(--neon); font-weight: 900; pointer-events: none;
    animation: floatUp 0.7s forwards; font-size: 2rem; z-index: 1000;
}
@keyframes floatUp { to { transform: translateY(-120px); opacity: 0; } }
</style>
</head>
<body>

<div id="mainUI" class="flex flex-col h-screen p-6">
    <header class="flex justify-between items-center mb-4">
        <div onclick="openSecret()" class="cursor-pointer">
            <h1 class="text-2xl font-black text-cyan-400">MATISOV X</h1>
            <div class="flex items-center gap-2">
                <span id="lvlTag" class="text-[10px] bg-cyan-900 px-2 py-0.5 rounded text-white">LVL 1</span>
                <div class="w-16 h-1 bg-gray-800 rounded-full"><div id="lvlBarHeader" class="h-full bg-cyan-400" style="width:0%"></div></div>
            </div>
        </div>
        <div class="text-right">
            <div class="text-[10px] opacity-60 font-bold uppercase">Balance</div>
            <div id="balText" class="text-2xl font-black text-white">0</div>
        </div>
    </header>

    <div class="flex-grow relative flex items-center justify-center" id="tapArea">
        <div class="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
            <div class="w-full h-full" style="background: radial-gradient(circle, var(--neon) 0%, transparent 70%);"></div>
        </div>
        <img id="hero" src="https://raw.githubusercontent.com/CUBERIONAI/Matisov-X/main/file_0000000008b471f48ebdb6f35b1b1a5a.png">
    </div>

    <footer class="space-y-4">
        <div class="glass p-4">
            <div class="flex justify-between text-[10px] mb-1 font-bold">
                <span class="text-cyan-400">⚡ ENERGY</span>
                <span id="eneText">1000/1000</span>
            </div>
            <div class="h-2 bg-gray-900 rounded-full overflow-hidden">
                <div id="eneBar" class="h-full bg-cyan-400 transition-all"></div>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="openHub()" class="btn-neon py-4 text-xs font-black uppercase">Hub & Tasks</button>
            <button onclick="openSecret()" class="bg-white/10 py-4 rounded-xl text-xs font-black uppercase border border-white/10">Profile</button>
        </div>
    </footer>
</div>

<div id="secretScreen">
    <div class="flex justify-between items-center mb-8">
        <h2 class="text-cyan-400 font-black text-xl">CYBER PROFILE</h2>
        <button onclick="closeSecret()" class="text-3xl font-light">✕</button>
    </div>
    
    <div class="flex flex-col items-center mb-8">
        <div class="relative">
            <img id="uAvatar" src="https://via.placeholder.com/100" class="w-24 h-24 rounded-full border-4 border-cyan-400 p-1 shadow-[0_0_20px_#00d2ff]">
            <div id="uLvlBadge" class="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-cyan-400 text-black text-[10px] font-black px-3 py-0.5 rounded-full">LVL 1</div>
        </div>
        <div id="uName" class="font-black text-xl mt-4">GUEST USER</div>
    </div>

    <div id="ton-connect-button" class="flex justify-center mb-6"></div>
    
    <div class="space-y-3">
        <div class="glass p-4 flex justify-between items-center">
            <span class="text-xs opacity-60 font-bold uppercase">TON Wallet</span>
            <span id="tonStatus" class="text-xs text-red-500 font-bold">Not Connected</span>
        </div>
        <button onclick="TG.showAlert('Deposit system coming soon with TON Smart Contracts!')" class="w-full btn-neon py-4 text-xs">REFILL TON</button>
    </div>
</div>

<div id="hubModal">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-cyan-400 font-black text-xl uppercase">Cyber Hub</h2>
        <button onclick="closeHub()" class="text-3xl font-light">✕</button>
    </div>

    <div class="overflow-y-auto space-y-8 pr-2">
        <section>
            <h3 class="text-[11px] text-cyan-400 font-black mb-4 tracking-widest uppercase">Missions</h3>
            <div id="taskList" class="space-y-3"></div>
        </section>

        <section>
            <h3 class="text-[11px] text-white/40 font-black mb-4 tracking-widest uppercase">Upgrades</h3>
            <div id="upgList" class="space-y-3"></div>
        </section>
    </div>
</div>

<script>
const TG = window.Telegram.WebApp;
const UID = TG.initDataUnsafe?.user?.id || "guest";
TG.expand();

// TON Connect
const tonConnectUI = new TONConnectUI.TonConnectUI({
    manifestUrl: 'https://raw.githubusercontent.com/ton-connect/demo-dapp/main/public/tonconnect-manifest.json',
    buttonRootId: 'ton-connect-button'
});

let state = {
    bal: parseInt(localStorage.getItem('mx_bal_'+UID)) || 0,
    e: 1000,
    lvl: parseInt(localStorage.getItem('mx_lvl_'+UID)) || 1,
    hnd: parseInt(localStorage.getItem('mx_hnd_'+UID)) || 0, // Hands
    swd: parseInt(localStorage.getItem('mx_swd_'+UID)) || 0, // Sword
    tasks: JSON.parse(localStorage.getItem('mx_tsk_'+UID)) || []
};

const TASKS = [
    { id: 'tg_ch', title: 'Join Channel', reward: 1000000, link: 'https://t.me/Matisov_X' },
    { id: 'tg_group', title: 'Join Chat', reward: 1000000, link: 'https://t.me/MatisovX' },
    { id: 'yt', title: 'Subscribe YouTube', reward: 1000000, link: 'https://www.youtube.com/@MatisovX' },
    { id: 'inst', title: 'Instagram Follow', reward: 1000000, link: 'https://www.instagram.com/matisov.x' },
    { id: 'tw', title: 'Follow on X', reward: 1000000, link: 'https://x.com/matisovx' },
    { id: 'ton_con', title: 'Connect TON Wallet', reward: 100000, link: '#' }
];

function save() {
    localStorage.setItem('mx_bal_'+UID, state.bal);
    localStorage.setItem('mx_lvl_'+UID, state.lvl);
    localStorage.setItem('mx_hnd_'+UID, state.hnd);
    localStorage.setItem('mx_swd_'+UID, state.swd);
    localStorage.setItem('mx_tsk_'+UID, JSON.stringify(state.tasks));
}

function getExpNext() { return Math.floor(100000 * Math.pow(2, state.lvl - 1)); }

function render() {
    const exp = getExpNext();
    if(state.bal >= exp) { state.bal -= exp; state.lvl++; TG.HapticFeedback.notificationOccurred('success'); }

    document.getElementById('balText').textContent = state.bal.toLocaleString();
    document.getElementById('lvlTag').textContent = `LVL ${state.lvl}`;
    document.getElementById('uLvlBadge').textContent = `LVL ${state.lvl}`;
    document.getElementById('lvlBarHeader').style.width = (state.bal / exp * 100) + "%";
    
    const maxE = 1000 + (state.hnd * 200);
    document.getElementById('eneText').textContent = `${state.e}/${maxE}`;
    document.getElementById('eneBar').style.width = (state.e / maxE * 100) + "%";
    
    if(TG.initDataUnsafe?.user) {
        document.getElementById('uName').textContent = (TG.initDataUnsafe.user.username || TG.initDataUnsafe.user.first_name).toUpperCase();
        document.getElementById('uAvatar').src = TG.initDataUnsafe.user.photo_url || 'https://via.placeholder.com/100';
    }
}

// Завдання
function openHub() {
    document.getElementById('hubModal').style.display = 'flex';
    const list = document.getElementById('taskList');
    list.innerHTML = TASKS.map(t => {
        const isDone = state.tasks.includes(t.id);
        return `
        <div class="glass p-4 flex justify-between items-center">
            <div>
                <div class="text-xs font-black uppercase">${t.title}</div>
                <div class="text-[10px] text-green-400">+${t.reward.toLocaleString()} MX</div>
            </div>
            ${isDone ? '<span class="text-green-500 font-bold">COMPLETED</span>' : 
            `<button onclick="verifyTask('${t.id}')" class="bg-white text-black text-[10px] px-4 py-2 rounded-lg font-black uppercase">GO</button>`}
        </div>`;
    }).join('');

    const upgList = document.getElementById('upgList');
    const upgData = [
        { key: 'swd', name: 'Sword Force', cost: 5000 * (state.swd + 1), desc: 'More MX per tap' },
        { key: 'hnd', name: 'Cyber Hands', cost: 10000 * (state.hnd + 1), desc: 'Energy & Recovery' }
    ];
    upgList.innerHTML = upgData.map(u => `
        <div class="glass p-4 flex justify-between items-center">
            <div>
                <div class="text-xs font-black uppercase">${u.name}</div>
                <div class="text-[9px] opacity-50">Lvl ${state[u.key]} • ${u.desc}</div>
            </div>
            <button onclick="buyUpgrade('${u.key}', ${u.cost})" class="btn-neon text-[10px] px-4 py-2 uppercase font-black">
                ${u.cost.toLocaleString()}
            </button>
        </div>
    `).join('');
}

function verifyTask(id) {
    const task = TASKS.find(t => t.id === id);
    if(id === 'ton_con') {
        if(tonConnectUI.connected) claimTask(id, task.reward);
        else TG.showAlert("Please connect TON wallet in your profile first!");
    } else {
        TG.openLink(task.link);
        setTimeout(() => {
            TG.showConfirm("Task check: Did you complete the subscription?", (ok) => {
                if(ok) claimTask(id, task.reward);
            });
        }, 2000);
    }
}

function claimTask(id, reward) {
    if(!state.tasks.includes(id)) {
        state.tasks.push(id);
        state.bal += reward;
        save(); render(); openHub();
        TG.HapticFeedback.notificationOccurred('success');
    }
}

function buyUpgrade(key, cost) {
    if(state.bal >= cost) {
        state.bal -= cost;
        state[key]++;
        save(); render(); openHub();
        TG.HapticFeedback.notificationOccurred('success');
    } else {
        TG.showAlert("Not enough MX!");
    }
}

// Тапи
document.getElementById('tapArea').addEventListener('touchstart', (e) => {
    e.preventDefault();
    const maxE = 1000 + (state.hnd * 200);
    Array.from(e.changedTouches).forEach(touch => {
        if(state.e <= 0) return;
        state.e--;
        const power = 1 + state.swd;
        state.bal += power;
        
        const txt = document.createElement('div');
        txt.className = 'tap-text';
        txt.style.left = touch.clientX + 'px';
        txt.style.top = touch.clientY + 'px';
        txt.textContent = `+${power}`;
        document.body.appendChild(txt);
        setTimeout(() => txt.remove(), 700);
        
        document.getElementById('hero').style.transform = 'scale(0.9) rotate(-3deg)';
        setTimeout(() => document.getElementById('hero').style.transform = 'scale(1) rotate(0)', 80);
    });
    render(); save();
    TG.HapticFeedback.impactOccurred('medium');
});

// Навігація
function openSecret() { document.getElementById('secretScreen').style.display = 'flex'; }
function closeSecret() { document.getElementById('secretScreen').style.display = 'none'; }
function closeHub() { document.getElementById('hubModal').style.display = 'none'; }

tonConnectUI.onStatusChange(wallet => {
    document.getElementById('tonStatus').textContent = wallet ? "Connected" : "Not Connected";
    document.getElementById('tonStatus').className = wallet ? "text-green-400 text-xs font-bold" : "text-red-500 text-xs font-bold";
});

setInterval(() => {
    const max = 1000 + (state.hnd * 200);
    if(state.e < max) { state.e = Math.min(max, state.e + (1 + state.hnd)); render(); }
}, 1000);

render();
</script>
</body>
</html>
